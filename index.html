  <html>
    <head>
        <title>Xprin User Blog</title>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
        <link rel="icon" href="favicon.ico" type="image/x-icon">
        <link rel="stylesheet" href="styles/main.css">
        <link href="https://fonts.googleapis.com/css?family=Permanent+Marker" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css">
        <link rel="stylesheet" href="css/font-awesome.min.css">
        <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
</head>
    </head>

   <body >
      <style>
        #form{
          width: 470px;
           padding: 0 5px;
          margin: 0 auto;
        }
        input[type=text], select {
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type=submit] {
            width: 100%;
            background-color: #4CAF50;
            color: white;
            padding: 14px 20px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        input[type=submit]:hover {
            background-color: #45a049;
        }

        div {
            border-radius: 5px;
            background-color: #f2f2f2;
            padding: 20px;
        }
        .mPriv{
            background:red ; 
            height: 200px; 
            width:200px; 
            color:black; 
            box-shadow:1px 1px 1px 1px gray; 
            overflow:auto;
        }
        .todoM{
          height: 200px; 

           /*width:200px; */
          box-shadow:1px 1px 1px 1px gray; 
          overflow:auto;
          background-color: white;
          color: black;
        }
        .user{
          height: 200px; 
          /*width:200px; */
          box-shadow:1px 1px 1px 1px gray; 
          overflow:auto;
          background-color: white;
          
        }
        #mainPage,#globalMess{
            background-image: url("content/images/fondo.jpg");
        }
      </style>


    <div id="mainPage">
        <div id="LogIn" class="a1" style="margin: 100 auto; ">
          <div class="panel panel-header " align="center" style="background-color: #FF9900; ">
            <h1 style="color: black">Chat-App</h1>
          </div>
          <br><br><br>
            <div class="panel panel-default" style="width: 350px; margin:0 auto;">
               <!-- <div class="errormsg"></div> -->
                <h4>Username:</h4>
                <input type="text" class=" pull-right form-control box username" placeholder="username..." >
                <br><button class="fa fa btn btn-default btn-small glyphicon glyphicon-log-in"  type="button"> OK</button>
            </div>
           
        </div>

        <div id="globalMess" class="a2" style="display:none">
          <div class="panel panel-header " align="center" style="background-color: white; opacity: 0.6; ">
            <h1 style="color: black">Chat-App</h1>
          </div>
          <div class="row " style="  margin: 0 auto; background-color: #FF9900; ">
            <div class="allmsg todoM" align="center">
              
              <em align="center">Chat-Public</em><br><hr>
            </div>
          </div>

          <div style="background-color: orange">
            <form id="msgForm" class="form-my">
              <div class="wrapper" >
                <div class="row" >

                  <div class="usersnow user col-sm-3" style="float: right;" align="center">
                    <!--  To:<input type="text" class="to"> -->
                    <input type="text" title="Users Conected: "><br><hr>
                    
                  </div>
                  <div style="float: left; background-color: white;" class="privmsg mPriv col-sm-3">
                    
                      <em>Chat-Private: </em><br><hr>
                    
                  </div>

                  <div style="float: left;" class="col-sm-6"> 
                   Message: <input id="messageInput" type="text" class="msg_box" placeholder="message...." >
                   <input  style="width: 150px; float: left;" type="submit" value="Send to public">
                   <input style="float: left; width: 100px; height: 49px; margin-top: 9px; margin-left: 10px; "  id="emoji" type="button" value="emoji" title="Emoji" />
                  </div>
                </div>
           <!-- <div class="privmsg mPriv"></div>
                <div class="msg_ma_error"></div> -->
            
              </div>
              <div id="emojiWrapper"></div>       
            </form>
          </div>
        </div>
    </div>


   </body>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script  src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.1/socket.io.js"></script>
  
  <script type="text/javascript">
    window.onload = function() {
    var hichat = new HiChat();
    hichat.init();
};
var HiChat = function() {
    this.socket = null;
};
HiChat.prototype = {
    init: function() {
        var that = this;
        
        this._initialEmoji();
        document.getElementById('emoji').addEventListener('click', function(e) {
            var emojiwrapper = document.getElementById('emojiWrapper');
            emojiwrapper.style.display = 'block';
            e.stopPropagation();
        }, false);
        document.body.addEventListener('click', function(e) {
            var emojiwrapper = document.getElementById('emojiWrapper');
            if (e.target != emojiwrapper) {
                emojiwrapper.style.display = 'none';
            };
        });
        document.getElementById('emojiWrapper').addEventListener('click', function(e) {
            var target = e.target;
            if (target.nodeName.toLowerCase() == 'img') {
                var messageInput = document.getElementById('messageInput');
                messageInput.focus();
                messageInput.value = messageInput.value + '[emoji:' + target.title + ']';
            };
        }, false);
    },
    _initialEmoji: function() {
        var emojiContainer = document.getElementById('emojiWrapper'),
            docFragment = document.createDocumentFragment();
        for (var i = 69; i > 0; i--) {
            var emojiItem = document.createElement('img');
            emojiItem.src = '../content/emoji/' + i + '.gif';
            emojiItem.title = i;
            docFragment.appendChild(emojiItem);
        };
        emojiContainer.appendChild(docFragment);
    },
    _displayNewMsg: function(user, msg, color) {
        var container = document.getElementById('historyMsg'),
            msgToDisplay = document.createElement('p'),
            date = new Date().toTimeString().substr(0, 8),
            //determine whether the msg contains emoji
            msg = this._showEmoji(msg);
        msgToDisplay.style.color = color || '#000';
        msgToDisplay.innerHTML = user + '<span class="timespan">(' + date + '): </span>' + msg;
        container.appendChild(msgToDisplay);
        container.scrollTop = container.scrollHeight;
    },
    _displayImage: function(user, imgData, color) {
        var container = document.getElementById('historyMsg'),
            msgToDisplay = document.createElement('p'),
            date = new Date().toTimeString().substr(0, 8);
        msgToDisplay.style.color = color || '#000';
        msgToDisplay.innerHTML = user + '<span class="timespan">(' + date + '): </span> <br/>' + '<a href="' + imgData + '" target="_blank"><img src="' + imgData + '"/></a>';
        container.appendChild(msgToDisplay);
        container.scrollTop = container.scrollHeight;
    },
    _showEmoji: function(msg) {
        var match, result = msg,
            reg = /\[emoji:\d+\]/g,
            emojiIndex,
            totalEmojiNum = document.getElementById('emojiWrapper').children.length;
        while (match = reg.exec(msg)) {
            emojiIndex = match[0].slice(7, -1);
            if (emojiIndex > totalEmojiNum) {
                result = result.replace(match[0], '[X]');
            } else {
                result = result.replace(match[0], '<img class="emoji" src="./content/emoji/' + emojiIndex + '.gif" />');//todo:fix this in chrome it will cause a new request for the image
            };
        };
        return result;
    }
};

  </script>
   <script type="text/javascript">
  var socket = io.connect('192.168.1.77:3000');
  var userM= '';

  $('.btn').click(function() {
    var txt = $('.box').val();
    if ($.trim(txt) == '') {
       $('.errormsg').text('Please Enter Username');
    } else {
       socket.emit('New_user',txt ,function(data) {
          if (data) {
           $('.a1').hide();
           $('.a2').show();
          } else {
            $('.errormsg').text('Sorry User Already Exists;');
          }
       });
       $('.box').val('');
    }
  });

  socket.on('all_users',function(data) {
      $('.usersnow').html(data);
  });

  socket.on('snd_mg',function(data) {
      $('.allmsg').append(data + '<br>');
  });

  socket.on('call',function(data) {
      $('.privmsg').append(data + '<br>');
  });


  socket.on('eva',function(data) {
      $('.msg_ma_error').html(data + '<br>');
  });


  $('.form-my').submit(function (e){
      e.preventDefault();
      var msg = $('.msg_box').val(),
          to = '';

          if($.trim(to)===''){
            to=$.trim(userM);
          }

      var  msg1 = msg+'$'+to;
        if ($.trim(msg) !== '' || $.trim(to) !== '') {

          var mensaje = $(".msg_box").val();
          var nick = $(".username").val();
          var pm = $.trim(to) !== '';
          var para = $.trim(to);

          /*  $.post('http://localhost:3000/api/mensaje', {
        "nick": nick,
        "mensaje": mensaje,
        "pm": pm,
        "para": para
      }, function(serverResponse){
        //alert(serverResponse);
      //do what you want with server response

      });*/

           socket.emit('msg_k',msg1,function(data) {
          $('.msg_ma_error').html(data);
        });

        event = false;
        socket.emit('stop_ray',event);

        $('.msg_box').val('');
        $('.to').val('');
        userM='';
      }
  })

  function msgUser(usero){
    userM=usero;
    document.getElementById("msgForm").submit;
  }


  var timeout;
  var event;



  $('.msg_box').keyup(function() {
      var val = $(this).val();
      if (val.length >= 0.5) {
        event = true;
        socket.emit('typing_ray',event);
      }else{
        event = false;
        socket.emit('stop_ray',event);
      }

      
  });



   </script>
   

  </html>

